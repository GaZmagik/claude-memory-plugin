---
id: thought-20260112-002048
title: "Thinking: Test Framework: vitest vs bun:test"
type: temporary
scope: local
project: claude-memory-plugin
created: 2026-01-12T00:20:48Z
updated: 2026-01-12T00:25:50Z
tags: ["think", "concluded"]
links: []
topic: "Test Framework: vitest vs bun:test"
status: concluded
---

# Thinking: Test Framework: vitest vs bun:test

## Thoughts


### 2026-01-12T00:20:58Z - Thought
TECHNICAL COMPARISON:
- bun:test: Native to bun runtime, zero config needed, faster startup, built-in mocking via mock.module()
- vitest: Vite-powered, watch mode, snapshot testing, better TypeScript support, vi.mock() with proper cleanup
- Key difference: bun's mock.module() persists globally (causes our 173 failures), vitest's vi.mock() can be reset
- Both support describe/it/expect syntax
- vitest has richer assertion library (toMatchObject, toMatchSnapshot, etc.)

### 2026-01-12T00:21:11Z - Thought
INTEGRATION PERSPECTIVE:
- bun is already the package manager and runtime for this project
- vitest.config.ts exists (shows prior vitest intent)
- 16/19 test files already use vitest imports
- Only 3 files use bun:test (the polluting ones)
- bun runs vitest perfectly fine: 'bun test' can be aliased to 'bunx vitest'
- Mixing ecosystems is fine - bun is designed to be node-compatible

### 2026-01-12T00:21:24Z - Thought
MOCK & ISOLATION CAPABILITIES:
- vitest: vi.mock() hoists but vi.resetModules() properly cleans up, vi.spyOn() for partial mocks, vi.fn() for functions
- bun:test: mock.module() has NO proper cleanup mechanism - this is documented limitation
- vitest: supports isolate: true in config for worker-level isolation
- bun:test: no built-in file isolation, --max-concurrency doesn't isolate module state
- CRITICAL: Our 173 test failures are directly caused by bun's mock.module() pollution
- vitest mock cleanup is battle-tested (jest heritage)

### 2026-01-12T00:21:34Z - Thought
DEVELOPER EXPERIENCE:
- vitest: Excellent VS Code extension, inline test running, watch mode, UI dashboard
- bun:test: Minimal tooling, no VS Code integration, basic CLI output
- vitest: Rich documentation, large community, Stack Overflow answers
- bun:test: Growing but smaller community, less documentation on edge cases
- vitest: Familiar to anyone from Jest (99% API compatible)
- bun:test: Simpler API but less features

### 2026-01-12T00:23:26Z - Thought (Claude [9fd3ff7d-0df0-49f5-996b-709607025eb2])
MIGRATION COST ASSESSMENT: With 16/19 files already using vitest imports and an existing vitest.config.ts, migration is essentially a cleanup operation rather than a rewrite. The 3 bun:test files causing 173 failures need converting, but the syntax is nearly identical - primarily s/mock.module/vi.mock/ with added vi.resetModules() in afterEach hooks. The real cost of *not* migrating is ongoing debugging of non-deterministic test pollution, which will compound as the test suite grows beyond the current 1694 tests.

### 2026-01-12T00:24:01Z - Counter-argument (Claude [25c0f3db-4da2-410c-aa58-633df1fd6689])
The analysis overlooks bun's `--preload` flag with `mock.restore()` in a setup file, which could potentially solve isolation without full migration. Have you verified that vitest's `isolate: true` doesn't introduce its own performance penalty that negates bun's speed advantage? Also, the "16/19 already use vitest" metric is misleading if those 16 files represent trivial tests while the 3 bun:test files contain the complex, mock-heavy integration tests that actually need the native runtime's capabilities.

### 2026-01-12T00:24:21Z - Thought (Claude [fbe82fc6-18ea-47a8-a375-e1b5d18f218e])
SHIPPING DECISION: Migrate to vitest. The math is simple: 16/19 files already use vitest imports, vitest.config.ts exists, and bun's mock.module() has a documented limitation with no clean workaround. The counter-argument about `--preload` with `mock.restore()` is theoretical - if it worked, you wouldn't have 173 failures. Time-box this to 2 hours: convert the 3 bun:test files, add `vi.resetModules()` in afterEach hooks, run the suite. If failures drop below 20, you're done. If not, you have a different problem. Stop debating frameworks and start shipping green tests.

### 2026-01-12T00:24:45Z - Thought (Claude [ca39d26e-4063-42c0-ae21-7d6a8131ed8c])
**Risk assessment for vitest migration vs staying with bun:test:**

**Staying with bun:test risks (High severity):**
- **Ongoing test pollution** - 173 failures today becomes 500+ as test suite grows. Likelihood: Near-certain without isolation fix.
- **Debugging time sink** - Non-deterministic failures erode developer trust in tests → tests get ignored → bugs slip through. Blast radius: Entire CI/CD pipeline credibility.
- **bun mock API instability** - bun's test runner is younger than vitest; `mock.module()` limitations may persist for months/years. Likelihood: Medium-high given bun's priorities are runtime, not test tooling.

**Migrating to vitest risks (Medium severity):**
- **Ecosystem split** - Running vitest on bun means two systems to understand when debugging fails. Likelihood: Low impact given bun's node compatibility.
- **Performance regression** - vitest's `isolate: true` spawns workers → slower than bun's native speed. Mitigation: Benchmark before/after, only isolate problem files.
- **Future bun improvements orphaned** - If bun fixes mock isolation in 6 months, you've already migrated. Likelihood: Medium, but "working tests now" beats "maybe better tests later".

**Hidden risk either way:**
- The 3 bun:test files may be using `mock.module()` for things vitest's `vi.mock()` can't replicate (runtime-level module interception). Have you verified the mocks are semantically equivalent, not just syntactically similar?

### 2026-01-12T00:25:06Z - Thought (Claude [148c1c4d-8cef-4d62-a70b-41ce7860f8cd])
**ARCHITECTURAL COUPLING ANALYSIS:**

The test framework choice has deeper implications for the plugin architecture than the current analysis suggests. The hooks system (`PostToolUse`, `PreToolUse`), skills infrastructure, and memory CLI all rely on module boundaries that mocking must respect - vitest's `vi.mock()` with explicit reset aligns with the existing module graph where each skill/hook is a discrete unit, while bun's global `mock.module()` pollution violates the isolation assumptions baked into the skill registry pattern. More critically, the memory system's file-based storage (`graph.json`, `index.json`) means tests need deterministic filesystem state between runs - vitest's `beforeEach`/`afterEach` lifecycle hooks integrate cleanly with this cleanup pattern, whereas bun's lack of proper teardown has likely been causing subtle graph corruption in test fixtures that compounds the 173 failures beyond pure mock pollution.

### 2026-01-12T00:25:24Z - Alternative (Claude [d0efe39c-b529-4a14-a329-bf1000137058])
**HYBRID ISOLATION APPROACH:**

Before committing to full migration, test a surgical fix: move the 3 polluting bun:test files into a separate test command (`bun test:isolated`) that runs in a fresh process *after* the main vitest suite. This costs 30 minutes to try, preserves bun's native mocking where you actually need it, and answers whether the 173 failures are truly mock pollution or something else entirely. If failures persist even with process isolation, you've got a different root cause and vitest migration won't save you.

## Conclusion
DECISION: Test hybrid isolation first, then migrate to vitest if needed.

RATIONALE:
1. Simplifier's hybrid approach (30 min) validates root cause before 2-hour migration
2. If running 3 bun:test files in separate process fixes 173 failures → problem is mock pollution, proceed with vitest migration
3. If failures persist with isolation → different root cause, vitest won't help
4. 16/19 files already use vitest, config exists, migration is cleanup not rewrite
5. Risk-Assessor: staying with broken bun mocks has HIGH severity (erodes CI trust)
6. Architect: vitest's explicit cleanup aligns with plugin's module isolation patterns

IMMEDIATE ACTION: Run 3 polluting files separately to confirm diagnosis.

## Conclusion
DECISION: Test hybrid isolation first, then migrate to vitest if confirmed. Run 3 bun:test files separately - if failures drop, proceed with full vitest migration. 16/19 files already vitest, config exists, migration is cleanup not rewrite.
